---
title: "OS Command Injection"
date: "`r Sys.Date()`"
weight: 5
chapter: false
pre: " <b> 2.5 </b> "
---

Constructing operating system or shell commands with unsanitized user input can lead to inadvertently running malicious code. This kind of vulnerability allows an attacker to execute arbitrary commands on the host operating system under the privileges of the vulnerable application. Command injection attacks can lead to a wide range of malicious outcomes, including unauthorized data access, data corruption, denial of service, and complete system compromise.

1. Copy the following code within your IDE.

   ```
   def exec_command_noncompliant():

       from paramiko import client

       from flask import request

       address = request.args.get("address")

       cmd = "ping -c 1 %s" % address

       client = client.SSHClient()

       client.connect("ssh.samplehost.com")

       # Noncompliant: address argument is not sanitized.

       client.exec_command(cmd)
   ```

2. Run Amazon Q Project Scan to see how the OS command injection vulnerability is detected.
   ![OS-1](/images/5/OS-1.png?width=90pc)

3. To views details of the findings, hold your cursor over the insecure code and click on "View Details" to learn more:
   ![OS-2](/images/5/OS-2.png?width=90pc)
4. Whenever possible, avoid constructing shell commands with user inputs. Use language-specific APIs or libraries designed to perform the required actions without invoking the shell.

   Input Validation and Sanitization: If you must include user input in a shell command, rigorously validate the input to ensure it conforms to expected formats (e.g., alphanumeric only). Sanitize the input by escaping or removing potentially dangerous characters.

   Below is an example of how this code can be fixed. Make sure to save the file prior to re-running the scan.

   ```
   from paramiko import SSHClient, AutoAddPolicy
   import os
   import shlex

   def exec_command_compliant():
       # Retrieve SSH credentials and server details from environment variables
       ssh_host = os.getenv('SSH_HOST', 'default_host')
       ssh_username = os.getenv('SSH_USERNAME', 'default_username')
       ssh_password = os.getenv('SSH_PASSWORD', 'default_password')

       # Get the address from the request's query parameters
       from flask import request
       address = request.args.get("address")

       # Sanitize the address argument to prevent command injection
       safe_address = shlex.quote(address)

       # Prepare the ping command with the sanitized address
       cmd = f"ping -c 1 {safe_address}"

       # Initialize the SSH client and connect to the remote host
       client = SSHClient()
       client.load_system_host_keys()

       # Use environment variables for credentials
       client.connect(ssh_host, username=ssh_username, password=ssh_password)

       # Execute the command on the remote server
       stdin, stdout, stderr = client.exec_command(cmd)
       output = stdout.read().decode()

       # Close the SSH connection
       client.close()

       # Return or process the command's output
       return output
   ```
